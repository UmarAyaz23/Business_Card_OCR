<!DOCTYPE html>
<html lang = "en">

<head>
    <meta charset = "UTF-8"
    <meta http-equiv = "X-UA-Compatible" content = "IE=edge">
    <meta name = "viewport" content = "width = device-width, initial-scale = 1.0">

    <title>AI Business Card Data Extraction</title>
    <link rel = "preconnect" href = "https://fonts.googleapis.com">
    <link rel = "preconnect" href = "https://fonts.gstatic.com" crossorigin>
    <link href = "https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel = "stylesheet">
    <link rel = "stylesheet" href = "/static/styles.css">
</head>

<body>
    <section id = 'header'>
        <div class = 'container'>
            <a href = 'index.html'><h1>COMPANY NAME</h1></a>

            <div>
                <ul id = "navbar">
                    <li><a class = "active" href = "index.html">Home</a></li>
                    <li><a href = "">About</a></li>
                    <li><a href = "">Contact</a></li>
                </ul>
            </div>
        </div>
    </section>

    <section id = 'upload_card_image' class = 'container'>
        <div class = "upload_image_icon" id = 'preview_container'>
            <img id = 'preview_image' src = "/static/upload_image_icon.png" width="20%" />
        </div>

        <div class = 'upload_image_button'>
            <button class = 'basic' id = "upload_button">Select Image</button>
        </div>

        <input 
            type = "file"
            id = "upload_image"
            accept = ".jpg, .jpeg, .png" 
            style = "display: none;"
        />
        <p>Upload <strong>JPG</strong> or <strong>PNG</strong> Image Files</p>
    </section>


    <script>
        const uploadBtn = document.getElementById("upload_button");
        const uploadInput = document.getElementById("upload_image");

        uploadBtn.addEventListener("click", () => uploadInput.click());

        uploadInput.addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const allowedTypes = ["image/jpeg", "image/png"];
            if (!allowedTypes.includes(file.type)) {
                alert("Only JPG or PNG images are allowed.");
                return;
            }

            uploadBtn.innerText = "Processing your image...";
            uploadBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement("canvas");
                    const scaleFactor = 1200 / img.width;
                    canvas.width = 1200;
                    canvas.height = img.height * scaleFactor;

                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    const previewImg = document.getElementById("preview_image");
                    previewImg.src = canvas.toDataURL(file.type);
                    previewImg.style.display = "block";
                    previewImg.style.width = "100%";
                    previewImg.style.height = "auto";

                    canvas.toBlob(function (blob) {
                        const fileName = `upload_${Date.now()}.png`;
                        const resizedFile = new File([blob], fileName, { type: blob.type });

                        const formData = new FormData();
                        formData.append("file", resizedFile);

                        fetch("http://localhost:8000/upload/", {
                            method: "POST",
                            body: formData,
                        })
                        .then(res => {
                            if (res.redirected) {
                                window.location.href = res.url;
                            } else {
                                alert("Upload succeeded but no redirect received.");
                            }
                        })
                        .catch(err => {
                            alert("Upload failed.");
                            console.error("‚ùå Upload error:", err);
                        });
                    }, file.type);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    </script>

</body>
</html>